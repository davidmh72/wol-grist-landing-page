<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grist Landing Page</title>
    <!-- Grist Plugin API -->
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        /* Modern, Light Grist-like Theme */
        :root {
            --grist-color-bg: #FFFFFF;
            --grist-color-text: #222222;
            --grist-color-border: #D1D5DB;
            --grist-color-primary: #16A34A; /* Grist Green */
            --grist-color-primary-light: #DCFCE7;
            --grist-color-primary-hover: #15803D;
            --grist-color-secondary-text: #6B7280;
            --grist-color-card-bg: #F9FAFB;
            
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--grist-color-bg);
            color: var(--grist-color-text);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- Header & Toggle --- */
        .header-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .toggle-container {
            display: flex;
            gap: 8px;
            background-color: var(--grist-color-card-bg);
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--grist-color-border);
            width: fit-content;
        }

        .toggle-btn {
            background: none;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--grist-color-secondary-text);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background-color: var(--grist-color-primary);
            color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* --- Search Bar --- */
        .search-container {
            width: 100%;
        }

        #search-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 1px solid var(--grist-color-border);
            border-radius: 8px;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.2s;
        }

        #search-input:focus {
            border-color: var(--grist-color-primary);
            box-shadow: 0 0 0 3px var(--grist-color-primary-light);
        }

        /* --- Grid (Results) --- */
        #grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .grid-item {
            padding: 16px;
            border: 1px solid var(--grist-color-border);
            border-radius: 8px;
            background-color: var(--grist-color-bg);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .grid-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-color: var(--grist-color-primary);
        }

        .grid-item-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .grid-item-subtitle {
            font-size: 14px;
            color: var(--grist-color-secondary-text);
        }

        /* --- Details Card --- */
        #card-container {
            display: none; /* Hidden by default */
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .btn-back {
            background: none;
            border: none;
            color: var(--grist-color-primary);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            padding: 0;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-back:hover {
            text-decoration: underline;
            color: var(--grist-color-primary-hover);
        }

        .profile-card {
            border: 1px solid var(--grist-color-border);
            border-radius: 12px;
            padding: 24px;
            background-color: var(--grist-color-bg);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--grist-color-border);
        }

        .profile-avatar {
            width: 64px;
            height: 64px;
            background-color: var(--grist-color-primary-light);
            color: var(--grist-color-primary-hover);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        .profile-name {
            font-size: 24px;
            font-weight: bold;
            margin: 0 0 4px 0;
        }

        .profile-type {
            font-size: 14px;
            color: var(--grist-color-secondary-text);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .detail-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: 12px;
            color: var(--grist-color-secondary-text);
            font-weight: 600;
            text-transform: uppercase;
        }

        .detail-value {
            font-size: 15px;
            color: var(--grist-color-text);
        }

        /* --- Linked Items (Cross References) --- */
        .linked-items {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--grist-color-border);
        }

        .linked-items h3 {
            font-size: 14px;
            color: var(--grist-color-secondary-text);
            text-transform: uppercase;
            margin: 0 0 12px 0;
        }

        .linked-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border: 1px solid var(--grist-color-border);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--grist-color-bg);
        }

        .linked-item:hover {
            border-color: var(--grist-color-primary);
            background-color: var(--grist-color-primary-light);
        }

        .linked-item-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--grist-color-text);
        }

        .linked-item-badge {
            background-color: var(--grist-color-primary);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* --- Magic Grist Link --- */
        .btn-grist-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 8px;
            background-color: var(--grist-color-primary);
            color: white;
            border: 1px solid var(--grist-color-primary-hover);
            text-decoration: none;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            margin-left: auto; /* Push to right */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-grist-link:hover {
            background-color: var(--grist-color-primary-hover);
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        /* Loading state */
        #loading-indicator {
            text-align: center;
            padding: 40px;
            color: var(--grist-color-secondary-text);
            font-size: 16px;
        }
    </style>
</head>
<body>

    <div id="app">
        <!-- Main Landing View -->
        <div id="landing-view">
            <div class="header-section">
                <div class="toggle-container">
                    <button id="btn-contacts" class="toggle-btn active" onclick="setMode('contacts')">Contacts</button>
                    <button id="btn-organisations" class="toggle-btn" onclick="setMode('organisations')">Organisations</button>
                    <button id="btn-events" class="toggle-btn" onclick="setMode('events')">Events</button>
                    <button id="btn-countries" class="toggle-btn" onclick="setMode('countries')">Countries</button>
                    <button id="btn-languages" class="toggle-btn" onclick="setMode('languages')">Languages</button>
                </div>
                
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Search contacts by name or email..." oninput="handleSearch()">
                </div>
            </div>

            <div id="loading-indicator">Loading database...</div>
            <div id="grid-container"></div>
        </div>

        <!-- Details Card View -->
        <div id="card-container">
            <button class="btn-back" onclick="showLanding()">← Back to Results</button>
            <div id="card-content">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <script>
        // --- DEVELOPER NOTE: ALWAYS UPDATE THIS VERSION TAG ON EVERY SAVE ---
        const WIDGET_VERSION = "1.1.3";
        console.log(`[Grist Landing Page] Widget Version: ${WIDGET_VERSION}`);

        // --- Global State ---
        let currentMode = 'contacts'; // 'contacts' or 'organisations'
        let data = {
            contacts: [],
            organisations: [],
            contactOrganisations: [],
            events: [],
            countries: [],
            languages: []
        };
        let filteredData = [];

        // --- DOM Elements ---
        const btnContacts = document.getElementById('btn-contacts');
        const btnOrgs = document.getElementById('btn-organisations');
        const btnEvents = document.getElementById('btn-events');
        const btnCountries = document.getElementById('btn-countries');
        const btnLanguages = document.getElementById('btn-languages');
        const searchInput = document.getElementById('search-input');
        const gridContainer = document.getElementById('grid-container');
        const landingView = document.getElementById('landing-view');
        const cardContainer = document.getElementById('card-container');
        const cardContent = document.getElementById('card-content');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Grist Initialization ---
        grist.ready({
            requiredAccess: 'read table',
            allowSelectBy: true // Allow widget to send cursor updates if needed
        });

        // Listen for the widget gaining access to data
        grist.onRecords(async () => {
            // Fetch core tables and the linking table
            try {
                const contactsRaw = await grist.docApi.fetchTable('Contacts');
                const orgsRaw = await grist.docApi.fetchTable('Organisations');
                const contactOrgsRaw = await grist.docApi.fetchTable('ContactOrganisations');
                const eventsRaw = await grist.docApi.fetchTable('Events');
                const countriesRaw = await grist.docApi.fetchTable('Countries');
                const languagesRaw = await grist.docApi.fetchTable('Languages');

                // Normalize data structure for easier rendering
                data.contacts = formatGristData(contactsRaw).sort((a, b) => (a.Contact_ || '').localeCompare(b.Contact_ || ''));
                data.organisations = formatGristData(orgsRaw).sort((a, b) => (a.Organisation_ || '').localeCompare(b.Organisation_ || ''));
                data.contactOrganisations = formatGristData(contactOrgsRaw);
                data.events = formatGristData(eventsRaw).sort((a, b) => (a.Event_Summary || a.Event_ || '').localeCompare(b.Event_Summary || b.Event_ || ''));
                data.countries = formatGristData(countriesRaw).sort((a, b) => (a.Country || '').localeCompare(b.Country || ''));
                data.languages = formatGristData(languagesRaw).sort((a, b) => (a.Language || '').localeCompare(b.Language || ''));

                loadingIndicator.style.display = 'none';
                
                // Render initial state
                setMode('contacts');
            } catch (error) {
                loadingIndicator.innerText = "Error loading data. Ensure the widget has Read Access to the document.";
                console.error("Grist API Error:", error);
            }
        });

        // Helper to convert Grist's columnar data
        function formatGristData(gristTable) {
            if (!gristTable.id) return [];
            const rows = [];
            for (let i = 0; i < gristTable.id.length; i++) {
                const row = { id: gristTable.id[i] };
                for (const col in gristTable) {
                    if (col !== 'id') {
                        row[col] = gristTable[col][i];
                    }
                }
                rows.push(row);
            }
            return rows;
        }

        // --- Data Relationship Helpers ---

        function getLinkedOrganisations(contactId) {
            const links = data.contactOrganisations.filter(co => co.Contact === contactId);
            return links.map(link => {
                const org = data.organisations.find(o => o.id === link.Organisation);
                if (!org) return null;
                return { ...org, isPrimary: link.Primary };
            }).filter(Boolean); // remove nulls if org was deleted
        }

        function getLinkedContacts(orgId) {
            const links = data.contactOrganisations.filter(co => co.Organisation === orgId);
            return links.map(link => {
                const contact = data.contacts.find(c => c.id === link.Contact);
                if (!contact) return null;
                return { ...contact, isPrimary: link.Primary };
            }).filter(Boolean);
        }

        // --- UI Logic & Navigation ---

        function setMode(mode) {
            currentMode = mode;
            
            // Update Buttons
            [btnContacts, btnOrgs, btnEvents, btnCountries, btnLanguages].forEach(btn => btn.classList.remove('active'));
            if (mode === 'contacts') {
                btnContacts.classList.add('active');
                searchInput.placeholder = "Search contacts by name or email...";
            } else if (mode === 'organisations') {
                btnOrgs.classList.add('active');
                searchInput.placeholder = "Search organisations by name or type...";
            } else if (mode === 'events') {
                btnEvents.classList.add('active');
                searchInput.placeholder = "Search events...";
            } else if (mode === 'countries') {
                btnCountries.classList.add('active');
                searchInput.placeholder = "Search countries...";
            } else if (mode === 'languages') {
                btnLanguages.classList.add('active');
                searchInput.placeholder = "Search languages...";
            }

            // Reset Search and Render
            searchInput.value = '';
            filteredData = [...data[currentMode]];
            renderGrid();
            showLanding();
        }

        function showContact(contactId) {
            const contact = data.contacts.find(c => c.id === contactId);
            if (contact) {
                // Ensure UI reflects the correct mode
                btnContacts.classList.add('active');
                btnOrgs.classList.remove('active');
                currentMode = 'contacts';
                searchInput.placeholder = "Search contacts by name or email...";
                renderCard(contact);
            }
        }

        function showOrganisation(orgId) {
            const org = data.organisations.find(o => o.id === orgId);
            if (org) {
                btnOrgs.classList.add('active');
                btnContacts.classList.remove('active');
                currentMode = 'organisations';
                searchInput.placeholder = "Search organisations by name or type...";
                renderCard(org);
            }
        }

        function handleSearch() {
            const query = searchInput.value.toLowerCase();
            const currentList = data[currentMode];

            if (!query) {
                filteredData = [...currentList];
            } else {
                filteredData = currentList.filter(row => {
                    if (currentMode === 'contacts') {
                        const name = `${row.First_Name_ || ''} ${row.Last_Name || ''}`.toLowerCase();
                        const email = (row.Email_ || '').toLowerCase();
                        return name.includes(query) || email.includes(query);
                    } else if (currentMode === 'organisations') {
                        const orgName = (row.Organisation_ || '').toLowerCase();
                        const type = (row.Type_ || '').toLowerCase();
                        return orgName.includes(query) || type.includes(query);
                    } else if (currentMode === 'events') {
                        const eventName = (row.Event_Summary || row.Event_ || '').toLowerCase();
                        return eventName.includes(query);
                    } else if (currentMode === 'countries') {
                        return (row.Country || '').toLowerCase().includes(query);
                    } else if (currentMode === 'languages') {
                        return (row.Language || '').toLowerCase().includes(query);
                    }
                });
            }
            renderGrid();
        }

        function renderGrid() {
            gridContainer.innerHTML = '';
            
            if (filteredData.length === 0) {
                gridContainer.innerHTML = '<div style="color: var(--grist-color-secondary-text);">No results found.</div>';
                return;
            }

            filteredData.forEach(row => {
                const item = document.createElement('div');
                item.className = 'grid-item';
                
                if (currentMode === 'contacts') {
                    const fullName = row.Contact_ || `${row.First_Name_ || ''} ${row.Last_Name || ''}`.trim() || 'Unknown Contact';
                    item.innerHTML = `
                        <div class="grid-item-title">${fullName}</div>
                        <div class="grid-item-subtitle">${row.Email_ || 'No email provided'}</div>
                    `;
                } else if (currentMode === 'organisations') {
                    const orgName = row.Organisation_ || 'Unknown Organisation';
                    item.innerHTML = `
                        <div class="grid-item-title">${orgName}</div>
                        <div class="grid-item-subtitle">${row.Type_ || 'No type specified'}</div>
                    `;
                } else if (currentMode === 'events') {
                    const eventName = row.Event_Summary || row.Event_ || 'Unknown Event';
                    item.innerHTML = `
                        <div class="grid-item-title">${eventName}</div>
                        <div class="grid-item-subtitle">${row.Track_ || 'No track'}</div>
                    `;
                } else if (currentMode === 'countries') {
                    item.innerHTML = `
                        <div class="grid-item-title">${row.Country || 'Unknown Country'}</div>
                        <div class="grid-item-subtitle">Country</div>
                    `;
                } else if (currentMode === 'languages') {
                    item.innerHTML = `
                        <div class="grid-item-title">${row.Language || 'Unknown Language'}</div>
                        <div class="grid-item-subtitle">Language</div>
                    `;
                }

                item.onclick = () => renderCard(row);
                gridContainer.appendChild(item);
            });
        }

        function extractGristLink(text) {
            if (!text) return null;
            // Handle Grist's markdown hyperlink formula: [label](url)appendedText
            const mdMatch = text.match(/\]\(([^)]+)\)(.*)/);
            if (mdMatch) {
                return mdMatch[1] + (mdMatch[2] || '');
            }
            if (text.startsWith('http') || text.startsWith('#')) return text;
            return null;
        }

        function renderCard(row) {
            // Hide landing, show card
            landingView.style.display = 'none';
            cardContainer.style.display = 'block';

            let html = '';
            
            // Extract the magic Grist jump link
            const linkUrl = extractGristLink(row.Link || row.E_Link || row.C_Link || row.OG_Link);
            const linkBtn = linkUrl ? `<a href="${linkUrl}" target="_top" class="btn-grist-link" title="Open Full Record in Grist">Open in Grist ↗</a>` : '';

            if (currentMode === 'contacts') {
                const fullName = row.Contact_ || `${row.First_Name_ || ''} ${row.Last_Name || ''}`.trim() || 'Unknown Contact';
                const initial = fullName.charAt(0).toUpperCase();
                
                // Build Linked Organisations list
                const linkedOrgs = getLinkedOrganisations(row.id);
                let linkedOrgsHtml = '';
                if (linkedOrgs.length > 0) {
                    linkedOrgsHtml = `
                        <div class="linked-items">
                            <h3>Linked Organisations</h3>
                            ${linkedOrgs.map(org => `
                                <div class="linked-item" onclick="showOrganisation(${org.id})">
                                    <span class="linked-item-title">${org.Organisation_ || 'Unknown'}</span>
                                    ${org.isPrimary ? '<span class="linked-item-badge">Primary</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                html = `
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar">${initial}</div>
                            <div style="flex-grow: 1;">
                                <h2 class="profile-name">${fullName}</h2>
                                <p class="profile-type">Contact Profile</p>
                            </div>
                            ${linkBtn}
                        </div>
                        <div class="profile-details">
                            ${buildDetailRow('Email', row.Email_ ? `<a href="mailto:${row.Email_}">${row.Email_}</a>` : '')}
                            ${buildDetailRow('Phone', row.Phone)}
                            ${buildDetailRow('Address', row.Address)}
                            ${buildDetailRow('Source', row.Source)}
                            ${buildDetailRow('Notes', row.Notes)}
                        </div>
                        ${linkedOrgsHtml}
                    </div>
                `;
            } else if (currentMode === 'organisations') {
                const orgName = row.Organisation_ || 'Unknown Organisation';
                const initial = orgName.charAt(0).toUpperCase();

                // Build Linked Contacts list
                const linkedContacts = getLinkedContacts(row.id);
                let linkedContactsHtml = '';
                if (linkedContacts.length > 0) {
                    linkedContactsHtml = `
                        <div class="linked-items">
                            <h3>Linked Contacts</h3>
                            ${linkedContacts.map(contact => {
                                const contactName = `${contact.First_Name_ || ''} ${contact.Last_Name || ''}`.trim() || 'Unknown';
                                return `
                                    <div class="linked-item" onclick="showContact(${contact.id})">
                                        <span class="linked-item-title">${contactName}</span>
                                        ${contact.isPrimary ? '<span class="linked-item-badge">Primary Contact</span>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                html = `
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar">${initial}</div>
                            <div style="flex-grow: 1;">
                                <h2 class="profile-name">${orgName}</h2>
                                <p class="profile-type">${row.Type_ || 'Organisation'}</p>
                            </div>
                            ${linkBtn}
                        </div>
                        <div class="profile-details">
                            ${buildDetailRow('Website', row.Website ? `<a href="${row.Website}" target="_blank">${row.Website}</a>` : '')}
                            ${buildDetailRow('Description', row.Description)}
                            ${buildDetailRow('Address', row.Address)}
                            ${buildDetailRow('Notes', row.Notes)}
                        </div>
                        ${linkedContactsHtml}
                    </div>
                `;
            } else if (currentMode === 'events') {
                const eventName = row.Event_Summary || row.Event_ || 'Unknown Event';
                const initial = eventName.charAt(0).toUpperCase();

                html = `
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar">${initial}</div>
                            <div style="flex-grow: 1;">
                                <h2 class="profile-name">${eventName}</h2>
                                <p class="profile-type">Event</p>
                            </div>
                            ${linkBtn}
                        </div>
                        <div class="profile-details">
                            ${buildDetailRow('Date', row.Date_)}
                            ${buildDetailRow('Track', row.Track_)}
                            ${buildDetailRow('Location', row.Location)}
                            ${buildDetailRow('Notes', row.Notes)}
                        </div>
                    </div>
                `;
            } else if (currentMode === 'countries') {
                const countryName = row.Country || 'Unknown Country';
                const initial = countryName.charAt(0).toUpperCase();
                html = `
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar">${initial}</div>
                            <div style="flex-grow: 1;">
                                <h2 class="profile-name">${countryName}</h2>
                                <p class="profile-type">Country</p>
                            </div>
                            ${linkBtn}
                        </div>
                    </div>
                `;
            } else if (currentMode === 'languages') {
                const languageName = row.Language || 'Unknown Language';
                const initial = languageName.charAt(0).toUpperCase();
                html = `
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar">${initial}</div>
                            <div style="flex-grow: 1;">
                                <h2 class="profile-name">${languageName}</h2>
                                <p class="profile-type">Language</p>
                            </div>
                            ${linkBtn}
                        </div>
                    </div>
                `;
            }

            cardContent.innerHTML = html;
        }

        function buildDetailRow(label, value) {
            if (!value) return '';
            return `
                <div class="detail-row">
                    <span class="detail-label">${label}</span>
                    <span class="detail-value">${value}</span>
                </div>
            `;
        }

        function showLanding() {
            cardContainer.style.display = 'none';
            landingView.style.display = 'block';
        }

    </script>
</body>
</html>
